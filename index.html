<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªá th·ªëng Ch·∫•m Thi Vovinam</title>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#f4f6f9;
}

header{
    background:#0d6efd;
    color:white;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.container{
    padding:20px;
}

.card{
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,0.08);
}

button{
    padding:8px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

.btn-primary{background:#0d6efd;color:white;}
.btn-danger{background:#dc3545;color:white;}
.btn-success{background:#198754;color:white;}
.btn-warning{background:#ffc107;color:black;}

.tabs button{
    margin-right:10px;
    background:#e9ecef;
}

.tab-content{
    display:none;
    margin-top:20px;
}

.tab-active{
    display:block;
}

input, select{
    padding:6px;
    margin:5px 0 15px 0;
    width:100%;
}

table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
}

table th, table td{
    border:1px solid #ddd;
    padding:6px;
    text-align:center;
}

.login-box{
    width:350px;
    margin:120px auto;   /* cƒÉn gi·ªØa ngang */
    text-align:center;
}

.login-box a:hover{
    text-decoration:underline;
}

.success{color:green;font-weight:bold;}

.table-wrapper{
    height: 500px;   /* gi·∫£m xu·ªëng th·∫•p */
    overflow-y: auto;
}

#scoreTable thead th{
    position: sticky;
    top: 0;
    background: #0d6efd;
    color: white;
    z-index: 3;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginPage" class="login-box card">
    <h2>H·ªÜ TH·ªêNG CH·∫§M THI VOVINAM</h2>

    <label>Ch·ªçn Gi√°m kh·∫£o</label>
    <select id="loginJudge">
        <option value="">-- Ch·ªçn --</option>
        <option>Admin</option>
        <option>Nguy·ªÖn Tr∆∞·ªùng ƒê·ªãnh</option>
        <option>B√πi Tu·∫•n ƒê·∫°t</option>
        <option>V≈© ƒê√¨nh ƒê·ªìng</option>
        <option>Nguy·ªÖn H·ªØu D≈©ng</option>
        <option>H·ªì Quang H√≤a</option>
        <option>Tr·∫ßn VƒÉn Hi·∫øn</option>
        <option>B√πi ƒê·ª©c Thao</option>
        <option>ƒê·∫∑ng Th·ªã Th·∫£o</option>
        <option>Tr·ªãnh Th·ªã Thu Th·∫£o</option>
        <option>L√™ Nh·∫≠t Long</option>
        <option>Ho√†ng Duy Nam</option>
        <option>Nguy·ªÖn Danh Ph√∫</option>
        <option>Nghi√™m Xu√¢n Quang</option>
        <option>Tr·∫ßn Cao Tr·ªçng</option>
        <option>Nguy·ªÖn Vi·∫øt Vƒ©nh</option>
        <option>H√≤ng Vi·ªát H√πng</option>
        <option>Ki·ªÅu VƒÉn H√πng</option>
    </select>

    <label>M·∫≠t kh·∫©u</label>
    <input type="password" id="loginPassword" placeholder="123456">

    <button class="btn-primary" onclick="login()">ƒêƒÇNG NH·∫¨P</button>

    <div style="margin-top:15px;">
        <a href="#" onclick="resetPassword()">Qu√™n m·∫≠t kh·∫©u?</a>
    </div>
</div>
<!-- ================= DASHBOARD ================= -->
<div id="dashboard" style="display:none;">

<header>
    <div>
        <strong>H·ªÜ TH·ªêNG CH·∫§M THI VOVINAM</strong><br>
        giamthiwellspring.site
    </div>
    <div>
        <span id="judgeName"></span>
        <button class="btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
</header>

<div class="container">

    <div class="tabs">
        <button onclick="openTab('setup')">Thi·∫øt l·∫≠p</button>
        <button onclick="openTab('score')">Phi·∫øu ƒëi·ªÉm</button>
        <button onclick="openTab('history')">L·ªãch s·ª≠</button>
        <button onclick="openTab('print')">PHI·∫æU ƒêI·ªÇM IN</button>
    </div>

    <!-- TAB 1 -->
    <div id="setup" class="tab-content tab-active card">
        <h3>Ch·ªçn kh√≥a thi</h3>

        <label>Ch·ªçn kh√≥a thi</label>
        <select id="examSelect">
        </select>
        <button class="btn-primary" onclick="confirmExam()">X√ÅC NH·∫¨N</button>
        <div id="welcomeBox" class="success"></div>
    </div>

    <!-- TAB 2 -->
    <div id="score" class="tab-content card">
        <h3>Phi·∫øu ƒëi·ªÉm</h3>

        <label>Ch·ªçn c·∫•p ƒëai</label>
        <select id="beltSelect">
            <option>Lam ƒëai I</option>
            <option>Lam ƒëai II</option>
            <option>Lam ƒëai III</option>
        </select>

        <div class="table-wrapper">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>H·ªç t√™n</th>
                    <th>NƒÉm sinh</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>L√Ω thuy·∫øt</th>
                    <th>ƒê√≤n cƒÉn b·∫£n</th>
                    <th>Chi·∫øn l∆∞·ª£c</th>
                    <th>Kh√≥a g·ª°</th>
                    <th>Giao ƒë·∫•u</th>
                    <th>V√µ l·ª±c</th>
                    <th>T·ªïng ƒëi·ªÉm</th>
                    <th>H·∫°ng</th>
                    <th>K·∫øt qu·∫£</th>                 
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>
        <h4>X√°c nh·∫≠n & K√Ω t√™n</h4>

        <label>H·ªç t√™n Gi√°m kh·∫£o</label>
        <input type="text" id="signatureName" placeholder="Nh·∫≠p h·ªç t√™n k√Ω x√°c nh·∫≠n">

        <label>Ch·ªçn ch·∫ø ƒë·ªô k√Ω</label>
        <select id="signatureMode" onchange="switchSignatureMode()">
            <option value="draw">V·∫Ω tr·ª±c ti·∫øp</option>
            <option value="upload">T·∫£i ·∫£nh ch·ªØ k√Ω</option>
        </select>

        <!-- V·∫º -->
        <div id="drawArea">
            <canvas id="signatureCanvas" width="400" height="150"
                style="border:1px solid #ccc; background:white;"></canvas>
            <br>
            <button type="button" class="btn-warning" onclick="clearCanvas()">X√≥a</button>
        </div>

        <!-- UPLOAD -->
        <div id="uploadArea" style="display:none;">
            <input type="file" id="signatureUpload" accept="image/*">
            <div id="previewBox"></div>
        </div>

        <br>
        <button class="btn-success" onclick="submitScore()">G·ª≠i ƒëi·ªÉm</button>
    </div>

    <!-- TAB 3 -->
    <div id="history" class="tab-content card">
    <h3>L·ªãch s·ª≠ g·ª≠i ƒëi·ªÉm</h3>

    <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
        <button class="btn-primary" onclick="renderHistory()">T·∫£i l·∫°i</button>
        <button class="btn-warning" onclick="clearHistory()">X√≥a l·ªãch s·ª≠ m√°y n√†y</button>
        <span id="historyStatus" style="opacity:.7;"></span>
    </div>

    <div class="table-wrapper" style="height:420px;">
        <table id="historyTable">
        <thead>
        <tr>
            <th>Th·ªùi gian g·ª≠i</th>
            <th>Phi·∫øu ƒëi·ªÉm c·∫•p ƒëai ƒë√£ ch·∫•m</th>
            <th>Tr·∫°ng th√°i g·ª≠i</th>
            <th>X√≥a</th>
        </tr>
        </thead>
        <tbody id="historyBody"></tbody>
        </table>
    </div>
    </div>
     <!-- TAB 4 -->   
    <div id="print" class="tab-content card">
    <h3>PHI·∫æU ƒêI·ªÇM IN</h3>

    <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
        <button class="btn-primary" onclick="loadPrintPdf()">T·∫£i phi·∫øu ƒëi·ªÉm</button>
        <a id="pdfOpenLink" target="_blank" style="text-decoration:none;"></a>
        <span id="printHint" style="opacity:.7;"></span>
    </div>

    <iframe
        id="pdfFrame"
        style="width:100%; height:75vh; border:1px solid #ddd; border-radius:8px; background:white;"
    ></iframe>
    </div>
</div>

<script>

const API_BASE =
  location.protocol === "file:"
    ? "http://127.0.0.1:5000/api"     // ‚úÖ khi m·ªü file HTML local
    : `${location.origin}/api`;       // ‚úÖ khi ch·∫°y online c√πng domain

let examConfirmed = false;
// ===================
// LOAD KH√ìA THI
// ===================
function loadExams(){
    fetch(API_BASE + "/exams")
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById("examSelect");
        select.innerHTML = "";

        data.forEach(exam=>{
            select.innerHTML += `<option value="${exam}">${exam}</option>`;
        });

        loadBelts();
    })
    .catch(err => {
        alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!");
        console.log(err);
    });
}

// ===================
// LOAD C·∫§P ƒêAI
// ===================
function loadBelts(){
    const exam = document.getElementById("examSelect").value;

    fetch(API_BASE + "/belts?exam=" + encodeURIComponent(exam))
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById("beltSelect");
        select.innerHTML = "";

        data.forEach(belt=>{
            select.innerHTML += `<option value="${belt}">${belt}</option>`;
        });
        loadExamHeaders();
        loadCandidates();
    });
}

// ===================
// LOAD TH√ç SINH
// ===================
function loadExamHeaders(){
    const belt = document.getElementById("beltSelect").value;

    fetch(`${API_BASE}/exam_contents?belt=${encodeURIComponent(belt)}`)
    .then(res => res.json())
    .then(contents => {

        const headers = document.querySelectorAll("#scoreTable thead th");

        // ‚úÖ 6 c·ªôt n·ªôi dung thi b·∫Øt ƒë·∫ßu t·ª´ c·ªôt index 4 (sau ƒê∆°n v·ªã)
        for(let i=0; i<6; i++){
            headers[i+4].innerText = contents[i];
        }
    });
}

async function submitScore(){

    const name = document.getElementById("signatureName").value.trim();
    const mode = document.getElementById("signatureMode").value;

    if(!name){
        alert("Vui l√≤ng nh·∫≠p h·ªç t√™n k√Ω x√°c nh·∫≠n");
        return;
    }

    let signatureData = null;

    if(mode === "draw"){
        signatureData = canvas.toDataURL();

        // ki·ªÉm tra c√≥ v·∫Ω ch∆∞a
        const blank = document.createElement("canvas");
        blank.width = canvas.width;
        blank.height = canvas.height;

        if(signatureData === blank.toDataURL()){
            alert("Vui l√≤ng k√Ω t√™n tr∆∞·ªõc khi g·ª≠i ƒëi·ªÉm");
            return;
        }
    }
    else{
        if(!uploadedSignature){
            alert("Vui l√≤ng t·∫£i ·∫£nh ch·ªØ k√Ω");
            return;
        }
        signatureData = uploadedSignature;
    }
    const exam = document.getElementById("examSelect").value;
    const rows = document.querySelectorAll("#scoreTable tbody tr");

    if(!exam){
        alert("Ch∆∞a ch·ªçn kh√≥a thi");
        return;
    }

    const promises = [];

    rows.forEach(row => {

        const candidate_id = row.getAttribute("data-id");
        const inputs = row.querySelectorAll("input");

        const scores = Array.from(inputs).map(i => {

            let raw = i.value.trim();

            // thay d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m
            raw = raw.replace(",", ".");

            const val = parseFloat(raw);

            return isNaN(val) ? 0 : val;
        });

        const request = fetch(`${API_BASE}/save_score`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                candidate_id: candidate_id,
                exam: exam,
                scores: scores
            })
        });

        promises.push(request);
    });

const belt = document.getElementById("beltSelect").value;

// t·∫°o 1 log l·ªãch s·ª≠ cho "1 l·∫ßn b·∫•m g·ª≠i"
const historyId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
addHistory({
  id: historyId,
  time: new Date().toISOString(),
  exam: exam,
  belt: belt,
  status: "SENDING"
});
renderHistory();

    try{
        // g·ª≠i ƒëi·ªÉm
        const resList = await Promise.all(promises);

        // n·∫øu c√≥ request n√†o kh√¥ng ok -> fail
        const anyFail = resList.some(r => !r.ok);
        if (anyFail) throw new Error("C√≥ request l∆∞u ƒëi·ªÉm b·ªã l·ªói HTTP");

        // l∆∞u ch·ªØ k√Ω
        const sigRes = await fetch(`${API_BASE}/save_signature`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                exam: exam,
                belt: belt,
                signature_name: name,
                signature_image: signatureData
            })
        });

        if (!sigRes.ok) throw new Error("L∆∞u ch·ªØ k√Ω th·∫•t b·∫°i (HTTP " + sigRes.status + ")");

        // DONE
        updateHistory(historyId, { status: "SENT" });
        renderHistory();

        const judge = localStorage.getItem("judge");
        const key = `draft_${judge}_${exam}_${belt}`;
        localStorage.removeItem(key);

        loadCandidates();
        alert("ƒê√£ l∆∞u ƒëi·ªÉm & k√Ω x√°c nh·∫≠n th√†nh c√¥ng");
        openTab("print");
        loadPrintPdf();
    }catch(error){
        console.error(error);

        updateHistory(historyId, { status: "FAILED", error: String(error) });
        renderHistory();

        alert("C√≥ l·ªói khi l∆∞u ƒëi·ªÉm");
    }
}

function loadCandidates(){

    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;
    if(!examConfirmed){
        alert("VUI L√íNG X√ÅC NH·∫¨N KH√ìA THI");
        return;
    }
    if(!exam || !belt) return;

    fetch(`${API_BASE}/candidates?exam=${encodeURIComponent(exam)}&belt=${encodeURIComponent(belt)}`)
    .then(res => res.json())
    .then(data => {

        const tbody = document.querySelector("#scoreTable tbody");
        tbody.innerHTML = "";

        data.forEach((c, index) => {

            const row = `
                <tr data-id="${c.id}">
                    <td>${index + 1}</td>
                    <td>${c.name}</td>
                    <td>${c.birth_year}</td>
                    <td>${c.unit ?? ""}</td>

                    ${c.scores.map(s => `
                        <td>
                        <input
                            type="text"
                            inputmode="decimal"
                            pattern="[0-9]*[.,]?[0-9]*"
                            autocomplete="off"
                            autocapitalize="off"
                            spellcheck="false"
                            value="${s ?? ''}"
                        >
                        </td>
                    `).join("")}

                    <td class="total-cell"><b>${c.total ? c.total : ""}</b></td>
                    <td>${c.rank ? c.rank : ""}</td>
                    <td>${c.result ? c.result : ""}</td>
                </tr>
            `;

            tbody.innerHTML += row;
        });
        restoreDraft();
        // ===============================
        // üî• VALIDATE + REALTIME TOTAL
        // ===============================

        const rows = document.querySelectorAll("#scoreTable tbody tr");

        rows.forEach(row => {

            const inputs = row.querySelectorAll("input");
            const totalCell = row.querySelector(".total-cell");

            inputs.forEach(input => {

                // CH·∫∂N K√ù T·ª∞ KH√îNG H·ª¢P L·ªÜ
                input.addEventListener("input", function(){

                    let val = this.value;

                    // ch·ªâ cho s·ªë + . + ,
                    val = val.replace(/[^0-9.,]/g, "");

                    // ƒë·ªïi , th√†nh .
                    val = val.replace(",", ".");

                    this.value = val;

                    calculateTotal();
                    saveDraft();
                });

                // CHU·∫®N H√ìA & GI·ªöI H·∫†N
                input.addEventListener("blur", function(){

                    let val = parseFloat(this.value.replace(",", "."));

                    if(isNaN(val)){
                        this.value = "";
                        calculateTotal();
                        return;
                    }

                    if(val < 0) val = 0;
                    if(val > 10) val = 10;

                    this.value = val.toFixed(1);

                    calculateTotal();
                    saveDraft();
                });

            });

            function calculateTotal(){

                let sum = 0;

                inputs.forEach(i=>{
                    let v = parseFloat(i.value);
                    if(!isNaN(v)) sum += v;
                });

                totalCell.innerHTML = "<b>" + sum.toFixed(1) + "</b>";
            }

        });

    })
    .catch(err => {
        console.error(err);
        alert("Kh√¥ng load ƒë∆∞·ª£c danh s√°ch th√≠ sinh");
    });
}

// ===================
// EVENT
// ===================
document.getElementById("examSelect")
.addEventListener("change", function(){
    const exam = this.value;

    document.getElementById("welcomeBox").innerHTML =
        "ƒê√£ ch·ªçn kh√≥a thi: <b>" + exam + "</b>";

    loadBelts();
});


document.getElementById("beltSelect")
.addEventListener("change", function(){
    loadExamHeaders();
    loadCandidates();
});


// ===================
// LOGIN
// ===================
async function login(){

    const judge = document.getElementById("loginJudge").value;
    const pass = document.getElementById("loginPassword").value;

    const res = await fetch(API_BASE + "/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            name: judge,
            password: pass
        })
    });

    const data = await res.json();

    if(data.status !== "success"){
        alert(data.message);
        return;
    }

    if(data.must_change === 1){
        showChangePasswordPopup(judge);
        return;
    }

    localStorage.setItem("judge", judge);

    document.getElementById("loginPage").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("judgeName").innerText = judge;

    loadExams();
    renderHistory();
}

function showChangePasswordPopup(name){

    while(true){

        const newPass = prompt("B·∫°n ƒëang d√πng m·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh.\nNh·∫≠p m·∫≠t kh·∫©u m·ªõi:");

        if(!newPass){
            alert("B·∫Øt bu·ªôc ph·∫£i ƒë·ªïi m·∫≠t kh·∫©u!");
            continue;   // quay l·∫°i nh·∫≠p l·∫°i l·∫ßn 1
        }

        if(newPass.length < 6){
            alert("M·∫≠t kh·∫©u ph·∫£i t·ªëi thi·ªÉu 6 k√Ω t·ª±");
            continue;
        }

        const confirmPass = prompt("Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi:");

        if(newPass !== confirmPass){
            alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp! Vui l√≤ng nh·∫≠p l·∫°i t·ª´ ƒë·∫ßu.");
            continue;   // quay l·∫°i nh·∫≠p l·∫°i l·∫ßn 1
        }

        // N·∫øu ƒë·∫øn ƒë√¢y nghƒ©a l√† h·ª£p l·ªá
        fetch(API_BASE + "/change_password", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                name:name,
                new_password:newPass
            })
        })
        .then(()=> {
            alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            location.reload();
        });

        break; // tho√°t v√≤ng l·∫∑p
    }
}

// ===================
// LOGOUT
// ===================
function logout(){
    localStorage.clear();
    location.reload();
}

function openTab(tabName){

    if ((tabName === "score" || tabName === "print") && !examConfirmed) {
        alert("VUI L√íNG X√ÅC NH·∫¨N KH√ìA THI");
        return;
    }

    const tabs = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
        tab.classList.remove("tab-active");
    });

    document.getElementById(tabName)
        .classList.add("tab-active");
    // ‚úÖ th√™m d√≤ng n√†y
    if (tabName === "history") renderHistory();
}

function confirmExam(){

    const exam = document.getElementById("examSelect").value;
    const judge = localStorage.getItem("judge");

    if(!exam){
        alert("Vui l√≤ng ch·ªçn kh√≥a thi");
        return;
    }

    examConfirmed = true;

    let role = "Gi√°m kh·∫£o";
    if(judge && judge.toLowerCase() === "admin"){
        role = "Ch√°nh Ch·ªß kh·∫£o";
    }

    document.getElementById("welcomeBox").innerHTML =
        `B·∫°n ƒë√£ ƒë∆∞·ª£c ph√¢n c√¥ng l√†m <b>${role}</b> c·ªßa kh√≥a thi: <b>${exam}</b>`;
}

function resetPassword(){

    const judge = document.getElementById("loginJudge").value;

    if(!judge){
        alert("Vui l√≤ng ch·ªçn gi√°m kh·∫£o");
        return;
    }

    fetch(API_BASE + "/request_reset", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ name: judge })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.status === "success"){
            alert("Y√™u c·∫ßu reset m·∫≠t kh·∫©u ƒë√£ g·ª≠i t·ªõi Ban t·ªï ch·ª©c.\nVui l√≤ng ch·ªù ph√™ duy·ªát.");
        }
    });
}

function saveDraft(){
    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;

    if(!exam || !belt) return;

    const rows = document.querySelectorAll("#scoreTable tbody tr");

    const draft = [];

    rows.forEach(row=>{
        const id = row.getAttribute("data-id");
        const inputs = row.querySelectorAll("input");

        const scores = Array.from(inputs).map(i=>i.value);

        draft.push({
            candidate_id: id,
            scores: scores
        });
    });

    const judge = localStorage.getItem("judge");
    const key = `draft_${judge}_${exam}_${belt}`;
    localStorage.setItem(key, JSON.stringify(draft));
}

function restoreDraft(){

    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;

    const judge = localStorage.getItem("judge");
    const key = `draft_${judge}_${exam}_${belt}`;
    const draft = localStorage.getItem(key);

    if(!draft) return;

    const data = JSON.parse(draft);

    data.forEach(item=>{
        const row = document.querySelector(
            `#scoreTable tbody tr[data-id="${item.candidate_id}"]`
        );

        if(!row) return;

        const inputs = row.querySelectorAll("input");

        item.scores.forEach((val, index)=>{
            if(inputs[index]){
                inputs[index].value = val;
            }
        });

        // T√≠nh l·∫°i t·ªïng
        let sum = 0;
        inputs.forEach(i=>{
            let v = parseFloat(i.value);
            if(!isNaN(v)) sum += v;
        });

        row.querySelector(".total-cell").innerHTML =
            "<b>" + sum.toFixed(1) + "</b>";
    });
}

function switchSignatureMode(){
    const mode = document.getElementById("signatureMode").value;

    document.getElementById("drawArea").style.display =
        mode === "draw" ? "block" : "none";

    document.getElementById("uploadArea").style.display =
        mode === "upload" ? "block" : "none";
}

const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");

let drawing = false;

canvas.addEventListener("mousedown", ()=> drawing = true);
canvas.addEventListener("mouseup", ()=> {
    drawing = false;
    ctx.beginPath();
});
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("touchstart", e => {
    drawing = true;
});

canvas.addEventListener("touchend", e => {
    drawing = false;
    ctx.beginPath();
});

canvas.addEventListener("touchmove", function(e){
    e.preventDefault();
    if(!drawing) return;

    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#0033CC";   // Blue ƒë·∫≠m

    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
});


function draw(e){
    if(!drawing) return;

    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#0033CC";   // Blue ƒë·∫≠m

    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function clearCanvas(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

let uploadedSignature = null;

document.getElementById("signatureUpload")
.addEventListener("change", function(){

    const file = this.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
        uploadedSignature = e.target.result;
        document.getElementById("previewBox").innerHTML =
            `<img src="${uploadedSignature}" width="200">`;
    };
    reader.readAsDataURL(file);
});

// ===================
// HISTORY (LOCAL)
// ===================
function getJudge() {
  return localStorage.getItem("judge") || "UNKNOWN";
}

function historyKey() {
  return `SEND_HISTORY::${getJudge()}`;
}

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(historyKey()) || "[]");
  } catch {
    return [];
  }
}

function saveHistory(list) {
  localStorage.setItem(historyKey(), JSON.stringify(list));
}

function addHistory(item) {
  const list = loadHistory();
  list.unshift(item); // m·ªõi nh·∫•t l√™n ƒë·∫ßu
  saveHistory(list);
}

function updateHistory(id, patch) {
  const list = loadHistory();
  const idx = list.findIndex(x => x.id === id);
  if (idx >= 0) {
    list[idx] = { ...list[idx], ...patch };
    saveHistory(list);
  }
}

function fmtTime(iso) {
  try {
    return new Date(iso).toLocaleString();
  } catch {
    return iso || "";
  }
}

function statusText(status) {
  if (status === "SENT") return "Th√†nh c√¥ng";
  if (status === "FAILED") return "Kh√¥ng th√†nh c√¥ng";
  if (status === "SENDING") return "ƒêang g·ª≠i";
  return status || "";
}

function statusColor(status) {
  if (status === "SENT") return "green";
  if (status === "FAILED") return "red";
  if (status === "SENDING") return "orange";
  return "";
}

function deleteHistoryItem(id) {
  const list = loadHistory();
  const item = list.find(x => x.id === id);

  const label = item ? `${item.exam || ""} - ${item.belt || ""}`.trim() : "";
  if (!confirm(`X√≥a l·ªãch s·ª≠ l·∫ßn g·ª≠i n√†y?\n${label}`)) return;

  const next = list.filter(x => x.id !== id);
  saveHistory(next);
  renderHistory();
}

function renderHistory() {
  const tbody = document.getElementById("historyBody");
  const statusEl = document.getElementById("historyStatus");
  if (!tbody) return;

  const list = loadHistory();
  tbody.innerHTML = "";

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; opacity:.7;">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>`;
    if (statusEl) statusEl.textContent = "";
    return;
  }

  for (const it of list) {
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = fmtTime(it.time);

    const td2 = document.createElement("td");
    td2.textContent = `${it.exam || ""} - ${it.belt || ""}`.trim();

    const td3 = document.createElement("td");
    td3.textContent = statusText(it.status);
    const c = statusColor(it.status);
    if (c) td3.style.color = c;
    td3.style.fontWeight = "bold";

    const td4 = document.createElement("td");
    const delBtn = document.createElement("button");
    delBtn.className = "btn-danger";
    delBtn.textContent = "X√≥a";
    delBtn.onclick = () => deleteHistoryItem(it.id);
    td4.appendChild(delBtn);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);

    tbody.appendChild(tr);
  }

  if (statusEl) statusEl.textContent = `T·ªïng: ${list.length} l·∫ßn`;
}

function clearHistory() {
  if (!confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ tr√™n m√°y n√†y?")) return;
  saveHistory([]);
  renderHistory();
}

function loadPrintPdf() {
  const exam = document.getElementById("examSelect").value;
  const belt = document.getElementById("beltSelect").value;
  if (!exam || !belt) {
    alert("Ch·ªçn kh√≥a thi v√† c·∫•p ƒëai tr∆∞·ªõc");
    return;
  }

  const organizer = ""; // n·∫øu mu·ªën truy·ªÅn ƒë∆°n v·ªã t·ªï ch·ª©c th√¨ g√°n v√†o ƒë√¢y

  const url =
    `${API_BASE}/print_score_pdf?exam=${encodeURIComponent(exam)}&belt=${encodeURIComponent(belt)}&organizer=${encodeURIComponent(organizer)}&t=${Date.now()}`;

  document.getElementById("pdfFrame").src = url;

  const link = document.getElementById("pdfOpenLink");
  link.href = url;
  link.textContent = "M·ªü PDF ·ªü tab m·ªõi";

  document.getElementById("printHint").textContent = `${exam} - ${belt}`;
}

</script>


</body>
</html>
